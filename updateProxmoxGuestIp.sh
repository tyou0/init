#!/bin/bash

HOSTS_FILE="/etc/hosts"
BACKUP="/etc/hosts.bak-$(date +%F-%H%M)"
NODE=$(hostname)

echo "Backing up current /etc/hosts to $BACKUP"
cp $HOSTS_FILE $BACKUP

# Remove old autogenerated lines
sed -i '/# PVE-AUTO-START/,/# PVE-AUTO-END/d' $HOSTS_FILE

echo "# PVE-AUTO-START" >> $HOSTS_FILE

for vmid in $(qm list | awk 'NR>1 {print $1}'); do

    # Get VM name
    name=$(qm config $vmid | awk -F ': ' '/^name:/{print $2}')

    # Get real IPv4 (skip 127.x.x.x)
    ip=$(qm guest cmd $vmid network-get-interfaces 2>/dev/null \
        | jq -r '.[]?."ip-addresses"[]?."ip-address"?' \
        | grep -E "^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" \
        | grep -v "^127\." \
        | head -n 1)

    if [[ -n "$ip" ]]; then
        echo "Adding: $ip    $name"
        echo "$ip    $name" >> $HOSTS_FILE
    else
        echo "VM $vmid ($name) has no IP via guest agent."
    fi
done

echo "# PVE-AUTO-END" >> $HOSTS_FILE

echo "Done."
